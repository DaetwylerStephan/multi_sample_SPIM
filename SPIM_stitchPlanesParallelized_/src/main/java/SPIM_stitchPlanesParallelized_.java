



import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;
import fiji.util.gui.GenericDialogPlus;
import ij.IJ;
import ij.ImageJ;
import ij.ImagePlus;
import ij.Macro;
import ij.plugin.PlugIn;
import ij.process.ImageProcessor;
import ij.process.ShortProcessor;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.nio.file.Files;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;










import java.util.List;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;
import java.util.concurrent.TimeUnit;

import stitching_preibisch.StitchingParameters;



public class SPIM_stitchPlanesParallelized_ implements PlugIn {
	int width;
	int height;
	/**
	 * @param args
	 */
	@Override
	public void run(String args) {
		
		
		int nbcores = Runtime.getRuntime().availableProcessors();
		String [] coreselect = new String[nbcores];
		for(int i=0;i<nbcores;i++){
			coreselect[i]=String.valueOf(i+1);
		}
				//generate an object of GenericDialog class to which options can be added and which can be evaluated
				final GenericDialogPlus gd = new GenericDialogPlus( "Indicate folder" );
					
				
				//generate options for the Plugin to work on SPIM data from the multi-sample SPIM
				gd.addFileField( "Foldername_to_process: ", "D:\\folder\\toprocess", 50 );
				gd.addFileField("Foldername_to_save: ", "D:\\folder\\tosave",50);
				gd.addStringField("Set_magnification: ","10", 30);
				gd.addStringField("Set_nbplanes: ","5", 30 );
				gd.addCheckbox("Invert: ", false);
				
				String[] applyRegistration ={"Apply registration from RegistrationInfoMax folder", "Calculate registration for stitching"};
				gd.addChoice("Calculate registration:", applyRegistration,"Calculate registration for stitching");
				
				String[] average_choices = {"calculate stitching on selected timepoints (average)", "calculate stitching for every timepoint individually",};
				gd.addChoice("Timepoint selection: ", average_choices, "calculate stitching on selected timepoints (average)");
				
				String[] data_for_stitching ={"calculate stitching parameters on maximum projection of the stack", "calculate data on 3D information"};
				gd.addChoice("Data for stitching: ", data_for_stitching, "calculate data on 3D information");
		
				gd.addChoice("How many threads", coreselect, coreselect[nbcores-1]);
	
				gd.showDialog();
				if ( gd.wasCanceled() )
					return;
				
				
				// read in input from plugin interface
				String directory_name = gd.getNextString();
				String foldername_save = gd.getNextString();
				int magnification = Integer.parseInt(gd.getNextString());
				int nbplanes = Integer.parseInt(gd.getNextString());
				Boolean invertIT = gd.getNextBoolean();
				int processingchoice = gd.getNextChoiceIndex();
				int averagechoice = gd.getNextChoiceIndex();
				int maxprochoice = gd.getNextChoiceIndex();
				
				String nbcoresString = gd.getNextChoice();
				int chosen_nbcores = Integer.parseInt(nbcoresString);
				
				// read in input if run as a plugin/macro on the cluster
				if(IJ.isMacro()){
					String options = Macro.getOptions();
					String[] listOptions = options.split(" ");
					String[] parsedOptions = new String[listOptions.length];
					IJ.log(options);
					for(int iter=0; iter<listOptions.length; iter++){
						String iterString = listOptions[iter];
						String[] tmplist = iterString.split("=");
						IJ.log(iterString);
						parsedOptions[iter] = tmplist[1];
						
					}
					directory_name = parsedOptions[0];
					foldername_save = parsedOptions[1];
					magnification = Integer.parseInt(parsedOptions[2]);
					nbplanes = Integer.parseInt(parsedOptions[3]);
					
					
					if(Integer.parseInt(parsedOptions[4])>0.1){
						invertIT =true;
					}else{invertIT=false;}
					
					processingchoice = Integer.parseInt(parsedOptions[5]);
					averagechoice = Integer.parseInt(parsedOptions[6]);
					maxprochoice = Integer.parseInt(parsedOptions[7]);
					chosen_nbcores = Integer.parseInt(parsedOptions[8]);
				}
				
				Boolean processing = false;
				Boolean maximumsprojection = false;
				Boolean averaging = false;
				
				if(processingchoice==1){processing = true;}
				if(averagechoice==0){averaging = true;}
				if(maxprochoice == 0){maximumsprojection = true;}
			
				
				IJ.log("Stitching will be done with: " + applyRegistration[processingchoice] + ", " + average_choices[averagechoice] + ", " + data_for_stitching[maxprochoice]);
				
				
				//find all events in the folder...
				FolderStructureP folderstructure = new FolderStructureP();
				folderstructure.setkeyword("zstack");

				//generate tree of data structure. 
				long starttime = System.currentTimeMillis();
				TreeP foldertree = folderstructure.generateFolderStructure(directory_name);
				long endtime = System.currentTimeMillis()- starttime;
				IJ.log("folderstructure was generated in: " + endtime  + "  ms containing " + foldertree.numberofNodePs(foldertree.getroot()) + " NodePs.");
				
				////////////////////////////////////////////////////
				//iterate over events
				////////////////////////////////////////////////////
				
				ArrayList<String> event_list2 = foldertree.searchfilename("e\\d{3}?");
				ArrayList<NodeP> event_list3 = foldertree.searchNodePname("e\\d{3}?");
				
				
				for(int eventindex = 0; eventindex<event_list2.size(); eventindex++){
				
					
				///get motor information about the position of the samples	from the .csv file
				String eventcsvname = event_list2.get(eventindex) + ".csv";
				IJ.log(eventcsvname);
				
				if(!new File(eventcsvname).exists()){IJ.log(".csv file was not found");}
				///open xml file
				try {
					XMLReader xmlreader = new XMLReader(event_list2.get(eventindex) + ".xml");
					this.width = xmlreader.width;
					this.height = xmlreader.height;
				} catch(Exception e) {
					throw new IllegalArgumentException("Error reading xml file: " + event_list2.get(eventindex) + ".xml", e);
				}
				
				CSVimportToTileWriter3 csvinfo = new CSVimportToTileWriter3();
				csvinfo.setmagnification(magnification);
				csvinfo.importdata(eventcsvname);
				
				//create subtree for experiment
				TreeP eventtree = foldertree.getsubtree(event_list3.get(eventindex));
				ArrayList<String> sample_list = eventtree.searchtree("s\\d{3}");
				Collections.sort(sample_list);
				
				ArrayList<Integer> startpoints = csvinfo.getStartpoints();
				startpoints.add(csvinfo.getPositionX().length);
				
				ArrayList<Integer> sampleindexlist = new ArrayList<Integer>();
				for(String ind:sample_list){
					int sampleindex = Integer.parseInt(ind.substring(1));
					sampleindexlist.add(sampleindex);
				}

				////////////////////////////////////////////////////
				//here starts the loop over an individual event/experiment
				///////////////////////////////////////////////////
				

				int angleindex=-1;
				
				while (!sampleindexlist.isEmpty()){				
				ArrayList<Integer> currentsamplelist = new ArrayList<Integer>();
				currentsamplelist.add(sampleindexlist.get(0));
				
				//find out boundaries of current angle
				int upperboundary = 0;
				for(int i = 0; i<startpoints.size(); i++){
					if(currentsamplelist.get(0)>=startpoints.get(i)){
						try{
						
						angleindex=i;
						upperboundary = startpoints.get(i+1);}
						catch(Exception e){
						upperboundary=startpoints.get(i);
						break;
				}}}
				
				
				//find out which indices are in the currentsamplelist (start at 1, since first index already contained in the list)
				for(int i=1; i<sampleindexlist.size();i++){
					if(sampleindexlist.get(i)<upperboundary){
						currentsamplelist.add(sampleindexlist.get(i));
						}}
				//Delete those indices
				for(int i=0;i<currentsamplelist.size();i++){sampleindexlist.remove(0);}
				
				
				
				//////////////////////////////////////////////////////////
				//determine which timepoints are in the data for stitching 
				//////////////////////////////////////////////////////////
				
				ArrayList<String> timepoints = new ArrayList<String>();
				ArrayList<String> alltimepoints = new ArrayList<String>();
				
				//get timepoint list 
				
				for(int i=0;i<currentsamplelist.size();i++){
					ArrayList<NodeP> n= eventtree.searchNodePname("s" + IJ.pad(currentsamplelist.get(i),3));
					ArrayList<String> timepointlist = n.get(0).getchildrendata();
					Collections.sort(timepointlist);
				
					if(i==0){
						alltimepoints=new ArrayList<String>(timepointlist);
						timepoints=new ArrayList<String>(timepointlist);
					}
					else{
						timepoints.retainAll(timepointlist);
						alltimepoints.removeAll(timepointlist);
						alltimepoints.addAll(timepointlist);
						Collections.sort(alltimepoints);
					}
				}
				
				Collections.sort(timepoints);
				Collections.sort(alltimepoints);
				
				///select 8 timepoints for stitching in selected timepointlist:
				ArrayList<String> selection_of_timepoints = new ArrayList<String>();
				int totalnbtimepoints = 8;
				for(int i=0; i<Math.min(timepoints.size(),totalnbtimepoints); i++){
					selection_of_timepoints.add(timepoints.get((int) (i*(timepoints.size()-1)/totalnbtimepoints)));
					
				}
				
				
				////////////////////////////////////////////////////////
				//timepoints> change from "t00001, t00002, ..." to "1,2,3,.."
				//of the list of all timepoints, and the list of the selection
				/////////////////////////////////////////////////////////
				ArrayList<Integer> timepointlist = new ArrayList<Integer>();
				ArrayList<Integer> timepointlist_selection = new ArrayList<Integer>();
				
				for(String timepoint_ind : alltimepoints){
					try{timepointlist.add(Integer.parseInt(timepoint_ind.substring(1)));}
					catch(Exception e){continue;}
				}	
				
				for(String timepoint_ind : selection_of_timepoints){
					try{timepointlist_selection.add(Integer.parseInt(timepoint_ind.substring(1)));}
					catch(Exception e){continue;}	
				}
	
				///////////////////////////////////////////////////////
				//Initialise parameters for later calculation
				///////////////////////////////////////////////////////
				
				String filename = null;
				ArrayList<Double> CalculatedPositionX_average = new ArrayList<Double>();
				ArrayList<Double> CalculatedPositionY_average = new ArrayList<Double>();
				int timeiter=0;
				int timepoint_index=timepointlist.get(timeiter);

		    	
				////////////////////////////////////////////////////////
				//check out directories, get plane lists...
				//get filenameparent (directory with all parent files)
				///////////////////////////////////////////////////////
				
				ArrayList<String> retainedplanes = new ArrayList<String>();
				
				//generate parentdirectory filename
		    	String[] filenameparent = new String[currentsamplelist.size()];
		
				ArrayList<String> planelistList = new ArrayList<String>(); //all files	
				
				
				///what to do if nothing to be stitched as only one region per angle is present
				
				if(currentsamplelist.size()==1){
					
					int sampleind = currentsamplelist.get(0);		
					NodeP samplepoint = eventtree.searchNodePname("s" + IJ.pad(sampleind, 3)).get(0);
					only1region(samplepoint,foldername_save, eventindex, event_list2, angleindex);
					continue;
				}
				
				
				// If there are more than one region per angle, you need to fuse them. 
				// Therefore, find all planes in all the regions to be stitched right now> save them to planelistList
				
		    	int index=0;
				for(int iter = 0; iter<currentsamplelist.size();iter++){	
					
					int sampleind = currentsamplelist.get(iter);		
					NodeP samplepoint = eventtree.searchNodePname("s" + IJ.pad(sampleind, 3)).get(0);
	
					String timepointstring = "t"+IJ.pad(timepoint_index,5);
					int isitthere = samplepoint.finddatainChildren(timepointstring);
					if(isitthere<0){index++; continue;}
					NodeP timepoint = samplepoint.getchild(isitthere);
				
					filename = timepoint.getparent().getfilename()+File.separator+ timepoint.godownNodeP() + File.separator + "zstack";
					File firstsample = new File(filename);
					
					String[] planelist = filter(firstsample.list(), "\\d{10}.dat");
					
					if(iter==0){
						retainedplanes=new ArrayList<String>(Arrays.asList(planelist));
						planelistList=new ArrayList<String>(Arrays.asList(planelist));}
					else{
						ArrayList<String>  planelistListtmp=new ArrayList<String>(Arrays.asList(planelist));
						retainedplanes.retainAll(planelistListtmp);
						planelistList.removeAll(planelistListtmp);
						planelistList.addAll(planelistListtmp);
					}
					filenameparent[index]=filename;index++;
					
				}
		    			
		    	String[] planelist = planelistList.toArray(new String [planelistList.size()]);
				
		
				
				/////////////////////////////////////////
				//Prepare everything for the registration and stitching
		    	////////////////////////////////////////
			
				/////// the general stitching parameters for the kind of stitching I like to do/////////
				final StitchingParameters params = new StitchingParameters();
				params.fusionMethod = 0;
				params.regThreshold = 0.3;
				params.relativeThreshold = 2.5;		
				params.absoluteThreshold = 3.5;
				params.computeOverlap = true;
				params.subpixelAccuracy = true;
				params.virtual = false;
				params.cpuMemChoice = 0;
				params.outputVariant =  1;
				params.outputDirectory = foldername_save;
				// we need to set this
				params.channel1 = 0;
				params.channel2 = 0;
				params.timeSelect = 0;
				params.checkPeaks = 60;
				params.dimensionality=2; 	
				
				
				ArrayList<Double> CalculatedPositionX = new ArrayList<Double>();
				ArrayList<Double> CalculatedPositionY = new ArrayList<Double>();
				if(processing == true){
				if(averaging==true){
					CalculatedPositionX = CalculatedPositionX_average;
					CalculatedPositionY = CalculatedPositionY_average;
				}
				
				/////////////////////////////////////////
				//At the first timepoint, calculate the stitching for all subsequent timepoints, by 
				//going over a small number of selected timepoints and finally taking the median of the calculated stitching parameters
				////////////////////////////////////////
				
				if(timeiter==0 && averaging==true){
					ArrayList<ArrayList<Double>> CalculatedAveragingX = new ArrayList<ArrayList<Double>>();
					ArrayList<ArrayList<Double>> CalculatedAveragingY = new ArrayList<ArrayList<Double>>();
					
					
					for(int timeiter2=0;timeiter2<timepointlist_selection.size();timeiter2++){
						int timepoint_index2=timepointlist_selection.get(timeiter2);
		
						ArrayList<String> retainedplanes2 = new ArrayList<String>();
						String[] filenameparent2 = new String[currentsamplelist.size()];
				    	String filename2 = null;
					
						int index2=0;
					for(int iter2 = 0; iter2<currentsamplelist.size();iter2++){	
						int sampleind = currentsamplelist.get(iter2);		
						NodeP samplepoint = eventtree.searchNodePname("s" + IJ.pad(sampleind, 3)).get(0);
						
						int isitthere = samplepoint.finddatainChildren("t" + IJ.pad(timepoint_index2,5));
						NodeP timepoint = samplepoint.getchild(isitthere);
						filename2 = timepoint.getparent().getfilename()+File.separator+ timepoint.godownNodeP() + File.separator + "zstack";
						File firstsample = new File(filename2);
						
						String[] planelist2 = filter(firstsample.list(), "\\d{10}.dat");
						
						if(iter2==0){
							retainedplanes2=new ArrayList<String>(Arrays.asList(planelist2));}
						else{
							ArrayList<String>  planelistListtmp=new ArrayList<String>(Arrays.asList(planelist));
							retainedplanes2.retainAll(planelistListtmp);
						}
						filenameparent2[index2]=filename2;index2++;
					}
					
						DoStitching stitchit = new DoStitching();
						stitchit.doStitching(CalculatedPositionX_average, CalculatedPositionY_average, params, csvinfo, filenameparent2, retainedplanes2, currentsamplelist, maximumsprojection, invertIT, nbplanes);
							
						CalculatedAveragingX.add(stitchit.getPositionX());
						CalculatedAveragingY.add(stitchit.getPositionY());	
					}
					
				
					//Calculate median (not average)
					for(int ii =0; ii<CalculatedAveragingX.get(0).size();ii++){
						ArrayList<Double> mediantmp = new ArrayList<Double>();
						ArrayList<Double> mediantmp2 = new ArrayList<Double>();
						
						for(int i = 0;i<CalculatedAveragingX.size();i++){
						mediantmp.add(CalculatedAveragingX.get(i).get(ii));
						mediantmp2.add(CalculatedAveragingY.get(i).get(ii));
						}
						Collections.sort(mediantmp);
						Collections.sort(mediantmp2);
						
						int middle = mediantmp.size()/2;
					    if (mediantmp.size()%2 == 1) {
					    	CalculatedPositionX.add(mediantmp.get(middle));
					    	CalculatedPositionY.add(mediantmp2.get(middle));
					    } else {
					    	CalculatedPositionX.add((Double) ((mediantmp.get(middle-1) + mediantmp.get(middle)) / 2.0));
					    	CalculatedPositionY.add((Double) ((mediantmp2.get(middle-1) + mediantmp2.get(middle)) / 2.0));
					    }
					}	
					CalculatedPositionX_average = CalculatedPositionX;
					CalculatedPositionY_average = CalculatedPositionY;			
					}			
				}
				else{
					
				///---------if you read in stitching parameters from the text file, they get loaded here
					int iterP = 1;
					int angle =0;
					System.out.println(currentsamplelist.get(0));
					System.out.println(csvinfo.getStartpoints().get(iterP));
					while(!(currentsamplelist.get(0)<csvinfo.getStartpoints().get(iterP))){
					System.out.println(currentsamplelist.get(0));
					System.out.println(csvinfo.getStartpoints().get(iterP));
						angle++;
					iterP++;	
					}
					
					String event_index = event_list2.get(eventindex).substring(event_list2.get(eventindex).length()-4, event_list2.get(eventindex).length());
					ArrayList<ArrayList<Double>> allarr = getinfofromfile(directory_name,  event_index,  angle);
					CalculatedPositionX = allarr.get(0);
					CalculatedPositionY = allarr.get(1);
					System.out.println(CalculatedPositionX.toString());
				}
				
		    	params.dimensionality=2;
		    	
		    	/////////////////////////////////////////////////////////////////////////////////////////////////////
		    	//fuse 3D stacks, go over timepoints and generate the queueing list for the multi-threading executor
		    	////////////////////////////////////////////////////////////////////////////////////////////////////
		    	
		    	ArrayList<Runnable> runnables2 = new ArrayList<Runnable>();	
						
		    	for(timeiter = 0; timeiter<timepointlist.size();timeiter++){
		    		
		    		//if you don't want to average parameters, you can also calculate it for every individual timepoint..
		    		if(averaging==false){
		    		IJ.log("Current iteration calculating " + timeiter);
		    		DoStitching stitchit = new DoStitching();
		    		stitchit.doStitching(CalculatedPositionX_average, CalculatedPositionY_average, params, csvinfo, filenameparent, retainedplanes, currentsamplelist, maximumsprojection, invertIT,nbplanes);
		    		CalculatedPositionX = stitchit.getPositionX();
		    		CalculatedPositionY = stitchit.getPositionY();
		    		CalculatedPositionX_average = stitchit.getaveragePositionX();
		    		CalculatedPositionY_average = stitchit.getaveragePositionY();
		    		}
		    		
		    		timepoint_index=timepointlist.get(timeiter);
		    		String[] filenameparenttimepoint = new String[currentsamplelist.size()];
		    			
		    		ArrayList<String> planelistList_timepoint = new ArrayList<String>(); //all files	
		    			
		    			
						for(int iter = 0; iter<currentsamplelist.size();iter++){
							
							int sampleind = currentsamplelist.get(iter);	
							
							NodeP samplepoint = eventtree.searchNodePname("s" + IJ.pad(sampleind, 3)).get(0);		
							String timepointstring = "t"+IJ.pad(timepoint_index,5);				
							int isitthere = samplepoint.finddatainChildren(timepointstring);
							
							if(isitthere<0){ continue;}
							
							NodeP timepoint = samplepoint.getchild(isitthere);
							String filenameP = timepoint.getparent().getfilename()+File.separator+ timepoint.godownNodeP() + File.separator + "zstack";
							File firstsample = new File(filenameP);
							
							String[] planelist_timepoint = filter(firstsample.list(), "\\d{10}.dat");
							
							if(iter==0){
								planelistList=new ArrayList<String>(Arrays.asList(planelist_timepoint));}
							else{
								ArrayList<String>  planelistListtmp=new ArrayList<String>(Arrays.asList(planelist_timepoint));
								planelistList_timepoint.removeAll(planelistListtmp);
								planelistList_timepoint.addAll(planelistListtmp);
							
							}
							
							filenameparenttimepoint[iter]=filenameP;
						}
						
		    			String[] planelist_timepoint_final = new String[planelistList_timepoint.size()];
		    			
		    			planelist_timepoint_final = planelistList_timepoint.toArray(planelist_timepoint_final);
		    			
					
						 FuseItRunnable currentrun = new FuseItRunnable();
						 currentrun.averaging= averaging;
						 currentrun.invertIT=invertIT;
						 currentrun.maximumsprojection=maximumsprojection;
						 currentrun.eventindex=eventindex;
						 currentrun.nbplanes=nbplanes;
						 currentrun.angleindex=angleindex;
						 currentrun.timepoint_index=timepoint_index;
						 currentrun.CalculatedPositionX=CalculatedPositionX;
						 currentrun.CalculatedPositionY=CalculatedPositionY;
						 currentrun.CalculatedPositionX_average=CalculatedPositionX_average;
						 currentrun.CalculatedPositionY_average=CalculatedPositionY_average;
						 currentrun.currentsamplelist=currentsamplelist;
						 currentrun.params=params;
						 currentrun.event_list2=event_list2;
						 currentrun.foldername_save=foldername_save;
						 currentrun.planelist=planelist_timepoint_final;
						 currentrun.filenameparent=filenameparenttimepoint;
						 currentrun.csvinfo=csvinfo;
						 currentrun.retainedplanes=retainedplanes;

						 runnables2.add(currentrun);
					 }
					 
					// cached thread pool executor
					ExecutorService execService = Executors.newFixedThreadPool(chosen_nbcores);	
					List<Callable<Object>> todo = new ArrayList<Callable<Object>>(runnables2.size());
					
					
					for(int i =0;i<runnables2.size();i++){
						todo.add(Executors.callable(runnables2.get(i)));
						//execService.execute(runnables2.get(i));
						
					}
					
					try {
						@SuppressWarnings("unused")
						List<Future<Object>>  answers = execService.invokeAll(todo);
					} catch (InterruptedException e) {
						
						e.printStackTrace();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
					}
					//otherwise not end to the program! Otherwise memory leak!
					execService.shutdown();
					try {
						execService.awaitTermination(1, TimeUnit.DAYS);
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
					
					if (execService.isShutdown()){
						IJ.log("Execution successful!");
						}
				
				}//all samples
				}//eventindex
	IJ.log("Stitching complete: " + foldername_save);			
	}//plugin end
	
	
	private void only1region(NodeP samplepoint, String foldername_save, int eventindex, ArrayList<String> event_list2, int angleindex) {
		List<NodeP> timelist = samplepoint.getchildren();
		
		for (NodeP timepoint: timelist){
		System.out.println(timepoint.getdata());
		if(timepoint.getdata().matches( "t\\d{5}?")){

		String filename = timepoint.getparent().getfilename()+File.separator+ timepoint.godownNodeP() + File.separator + "zstack";
		File firstsample = new File(filename);
		
		System.out.println(filename);
		String[] planelist = filter(firstsample.list(), "\\d{10}.dat");	
		
		for(int indexplanes= 0;indexplanes<planelist.length;indexplanes++ ){
		String planename = filename + File.separator + planelist[indexplanes];
		ImageProcessor ip;	
		try{
			ip = openRaw(planename, width, height, 0, width-1, 0, height-1);
			//if (invertIT == true){ip.flipHorizontal();}
			} catch (Exception e){
				continue;
			}
		String outputdirectory = foldername_save +  File.separator+ "TIFF"+ File.separator+event_list2.get(eventindex).substring(event_list2.get(eventindex).length()-4, event_list2.get(eventindex).length()) + File.separator + "angle"+ IJ.pad(angleindex, 3) + File.separator + timepoint.getdata() +  File.separator+ planelist[indexplanes].subSequence(0, planelist[indexplanes].length()-4) +".tif";
		System.out.println(outputdirectory);
		File outp = new File(outputdirectory);
		outp.getParentFile().mkdirs();
		ImagePlus reta = new ImagePlus("test", ip);
		IJ.save(reta,outputdirectory);
		}
		}
		}
		
	}


	//load data from .txt file if Registration has already been calculated, e.g. for the maximum intensity projections
	private ArrayList<ArrayList<Double>> getinfofromfile(String directory_name, String event_index, int anglenumber){
		ArrayList<Double> CalculatedPositionX = new ArrayList<Double>();
		ArrayList<Double> CalculatedPositionY = new ArrayList<Double>();
		ArrayList<ArrayList<Double>> returnit = new ArrayList<ArrayList<Double>>();
		
		
		String textfilename = directory_name+File.separator+ "RegistrationInfoMax"+File.separator+ event_index + "angle"+ IJ.pad(anglenumber, 3) + "t00001"+".txt" ;
		
		
		System.out.println("this here" + textfilename);
		
		if(!new File(textfilename).exists()){return returnit;}
		
		try {
			File myFile = new File(textfilename);
			FileReader fileReader;
			fileReader = new FileReader(myFile);
			BufferedReader reader = new BufferedReader(fileReader);
			String line =null;
			System.out.println("read in");
			while((line = reader.readLine())!=null){
				String[] twopositions = line.split("ypos");
				String xpos1 = twopositions[0].substring(5, twopositions[0].length()-1);
				String ypos1 = twopositions[1].substring(1, twopositions[1].length()-1);
				
				
				for(String s : xpos1.split(",")){
					Double res = Double.parseDouble(s); CalculatedPositionX.add(res);
				}		
				for(String s : ypos1.split(",")){
					Double res = Double.parseDouble(s); CalculatedPositionY.add(res);
				}		
				
				System.out.println(CalculatedPositionY.toString());
			}
			reader.close();
		} catch (FileNotFoundException e) {
		} catch (IOException e) {
			e.printStackTrace();
		}
		returnit.add(CalculatedPositionX);
		returnit.add(CalculatedPositionY);
		
		return returnit; 
	}		
			
	public static void main(String[] args2) {
		
		System.out.println("test");
		new ImageJ();
		
		IJ.runPlugIn("SPIM_stitchPlanesParallelized_","");
		
	}
	
	private static String[] filter(String[] in, String pattern) {
		ArrayList<String> all = new ArrayList<String>(in.length);
		for(String s : in)
			if(s.matches(pattern))
				all.add(s);
		String[] out = new String[all.size()];
		all.toArray(out);
		return out;
	}
	
	
		
		
	public static ArrayList<ArrayList<Double>> getCalibrationData(String textfilename){

		
		
		System.out.println("this here" + textfilename);	
		
		ArrayList<Double> CalculatedPositionX = new ArrayList<Double>();
		ArrayList<Double> CalculatedPositionY = new ArrayList<Double>();
		ArrayList<ArrayList<Double>> returnpositions = new ArrayList<ArrayList<Double>>();
		
		try {
			File myFile = new File(textfilename);
			FileReader fileReader;
			fileReader = new FileReader(myFile);
			BufferedReader reader = new BufferedReader(fileReader);
			String line =null;
			System.out.println("read in");
			while((line = reader.readLine())!=null){
				String[] twopositions = line.split("ypos");
				String xpos1 = twopositions[0].substring(5, twopositions[0].length()-1);
				String ypos1 = twopositions[1].substring(1, twopositions[1].length()-1);
				
					
				for(String s : xpos1.split(",")){
					Double res = Double.parseDouble(s); CalculatedPositionX.add(res);
				}		
				for(String s : ypos1.split(",")){
					Double res = Double.parseDouble(s); CalculatedPositionY.add(res);
				}		
				
				System.out.println(CalculatedPositionY.toString());
			}
			reader.close();
		} catch (FileNotFoundException e) {
		} catch (IOException e) {
			e.printStackTrace();
		}
		
		returnpositions.add(CalculatedPositionX);
		returnpositions.add(CalculatedPositionY);
		return returnpositions;
	}
		
		
		
		
		
		
	
	
	
	public static void copyFile( File from, File to ) throws IOException {
	    Files.copy( from.toPath(), to.toPath(),REPLACE_EXISTING);
	}
	
	
	public static ImageProcessor openRaw(String path, int orgW, int orgH, int xMin, int xMax, int yMin, int yMax) {
		//if(xMin == 0 && xMax == orgW - 1 && yMin == 0 && yMax == orgH - 1)
		//	return openRaw(path, orgW, orgH);
		int ws = xMax - xMin + 1;
		int hs = yMax - yMin + 1;
		
		//we need here two arrays since fileinputstream can only read in bytes, datainputstream is OS dependent
		//construct two arrays, and byte needs to be 2times bigger to reduce it then by half
		byte[] bytes = new byte[ws * hs * 2];
		short[] pixels = new short[ws * hs];

		FileInputStream in = null;
		try {
			in = new FileInputStream(path);

			// skip the top
			int toSkip = 2 * (yMin * orgW + xMin);
			while(toSkip > 0)
				toSkip -= in.skip(toSkip);

			// read through it line by line
			int offs = 0;
			for(int r = 0; r < hs; r++) {
				// read the data
				int read = 0;
				while(read < ws)
					//in.read reads the FileInputStream in, into bytes, starting from offs+reads up to 2*ws-read;
					//it returns as variable the number of bytes it has read
					read += in.read(bytes, offs + read, 2 * ws - read);
				offs += 2 * ws;

				// skip to next line
				toSkip = 2 * (orgW - xMax - 1 + xMin);
				while(toSkip > 0)
					toSkip -= in.skip(toSkip);
			}
			in.close();
		} catch(IOException e) {
			throw new RuntimeException("Cannot load " + path, e);
		}
		
		//0xff denotes 255 (hexadezimalsystem), since bytes goes from -127 to 127. You want to convert it to 0...255
		//therefore you use the bitwise operator &
		//do this for both bytes and then but them one after the other, where << denotes a shift by 8 and then do a bitwise or operation
		for(int i = 0; i < pixels.length; i++) {
			int low  = 0xff & bytes[2 * i];
			int high = 0xff & bytes[2 * i + 1];
			pixels[i] = (short)((high << 8) | low);
		}

		return new ShortProcessor(ws, hs, pixels, null);
	}
	
	
}
